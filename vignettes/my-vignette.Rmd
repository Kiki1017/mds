---
title: "Medical Devices Surveillance Data Standardization"
author: "Gary Chung"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Medical Devices Surveillance Data Standardization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Data on events involving medical devices comes in many shapes. Common challenges
include:

- Incompatibility of various sources of device-events
- Difficulty integrating exposures, a.k.a. denominator data
- Understanding all the possible combinations to analyze
- Quickly answering simple questions such as: Are events trending up? How did my trends look 1 year ago? 2 years ago?
- Application of disproportionality analysis (DPA) in the absence of exposure data
- Documentation of analyses in a auditable, reproducible way

The `mds` package is fast and easy to use. It solves the following:

- Standardizes events involving medical devices
- Standardizes exposures of the device (also known as opportunities for an event to occur, or event denominator)
- Enumerates possible analyses in a flexible way
- Generates times series of analyses for trending over time
- Sets up analyses for easy application of disproportionality analysis (DPA)
- Saves all the above in lightweight `R` files for auditability, documentation, and reproducibility

Furthermore, `mds` data and analysis standards allow for seamless application of various statistical trending algorithms via the `mdsstat` package (under development).

This document introduces you to the basics on using `mds`, including how to go from raw device-event and exposure data all the way to plotting event counts and rates over time, all in just a few steps.




## Data: MAUDE and Simulated Sales

Our example dataset `maude` was queried from the [FDA MAUDE API](https://open.fda.gov/api/) and contains 627 reported events on knee prostheses in 2017. Furthermore, a simulated exposure dataset `sales` was generated to provide denominator data for our knee implant events.

```{r}
library(mds)
dim(maude)
dim(sales)
# Displaying 1 row only, due to length of device names
maude[1, ]
sales[1, ]
```




## Raw Data to Trending in 4 Steps

The general workflow to go from data to trending over time is as follows:

1. Use `deviceevent()` to standardize device-event data.
2. Use `exposure()` to standardize exposure data (optional).
3. Use `define_analyses()` to enumerate possible analysis combinations.
4. Use `time_series()` to generate counts (and/or rates) by time based on your defined analyses.

Then you may run your own statistics, `plot()` your results, or use the `mdsstat` package.

### Live Example

```{r}
# Step 1 - Device Events
de <- deviceevent(
  maude,
  time="date_received",
  device_hierarchy=c("device_name", "device_class"),
  event_hierarchy=c("event_type", "medical_specialty_description"),
  key="report_number",
  covariates="region",
  descriptors="_all_")
# Step 2 - Exposures
ex <- exposure(
  sales,
  time="sales_month",
  device_hierarchy="device_name",
  match_levels="region",
  count="sales_volume")
# Step 3 - Define Analyses
da <- define_analyses(
  de,
  device_level="device_name",
  exposure=ex,
  covariates="region")
# Step 4 - Time Series
ts <- time_series(
  da,
  deviceevents=de,
  exposure=ex)

# Optional
# --------
# Summarize analyses
summary(da)
# Show analyses as a data frame
dadf <- define_analyses_dataframe(da)
head(dadf)
# Plot a time series of counts
plot(ts[[1]])
# Plot a time series of rates as a line graph
plot(ts[[4]], "rate", type='l')
```




## `deviceevent()` to standardize device-event data

#### Required Arguments

```{r}
# Basic usage
de <- deviceevent(maude, "date_received", c("device_name", "device_class"), c("event_type", "medical_specialty_description"))
class(de)
```

`deviceevent()` requires four arguments: `data_frame`, `time`, `device_hierarchy`, and `event_hierarchy`. 

- `data_frame` is the input device-event data frame. All remaining arguments refer to variables within this data frame.
- `time` is the name of the variable containing the time of the event. The input format of the time will be flexibly converted into `Date` format.
- `device_hierarchy` organizes all your device variables into a hierarchy. The hierarchical concept reflects how devices are often nested into progressively more general groups. Set the first variable as the lowest device level that you would like to trend at. `mds` remembers this hierarchy and allows trending at multiple levels as you specify.
- `event_hierarchy` organizes all your event variables into a hierarchy. Like devices, event variables should be categorical in nature. *Free text descriptions should not be listed here*, but rather in the `descriptors` argument. The hierarchical concept reflects how events are often nested into progressively more general groups. Set the first variable as the lowest event level that you would like to trend at. `mds` remembers this hierarchy and allows trending at multiple levels as you specify. *If your data does not have an event variable*, you will need to create a dummy variable.

#### Optional Arguments

```{r}
# Advanced usage
de <- deviceevent(
  maude,
  time="date_received",
  device_hierarchy=c("device_name", "device_class"),
  event_hierarchy=c("event_type", "medical_specialty_description"),
  key="report_number",
  covariates="region",
  descriptors="_all_")
class(de)
```

Optional arguments provide additional flexibility according to your data analysis needs.

- `key` is a unique identifier for each unique event in `data_frame`. If your data pipeline carries over a key variable, it is recommended to specify it here. The `key` allows downstream aggregated analysis to be able to "look up" individual constituent events.
- `covariates` are a special group of variables that may be analyzed within device. For instance, declaring `covariates="Region"` will allow analysis of regions within device. These variables should be categorical in nature.
- `descriptors` are additional variables that should be retained for the purpose of describing individual events in downstream analysis.
- `implant_days` contains the age in days of an implantable device at the time of the event.




## `exposure()` to standardize exposure data

Exposure data is meant to support device-event data. As such, the general expectation is that variable values match between exposure and device-event data. For example, 10 exposures in `Feb-2017` for `"ev3 Solitaire"` will be matched **exactly** to `Feb-2017` events for `"ev3 Solitaire"`, and not to events for `"EV3 SOLITAIRE"`.

#### Required Arguments

```{r}
# Basic usage
ex <- exposure(sales, "sales_month", "device_name")
class(ex)
```

`exposure()` requires three arguments: `data_frame`, `time`, and `device_hierarchy`. Although not required, `count` will commonly be used as well.

- `data_frame` is the input exposure data frame. All remaining arguments refer to variables within this data frame.
- `time` is the name of the variable containing the time of the exposure. The input format of the time will be flexibly converted into `Date` format. If exposure will be used, it is **critical** to have sufficient time granularity. For example, if analysis will be done monthly, exposure data must be no less granular than monthly. `mds` does not make assumptions about filling in holes in time!
- `device_hierarchy` contains all exposure device variables to match to your device-event data. As such, the values within these variables must match exactly to the values within each respective variable in the device-event data `device_hierarchy` parameter.
- `event_hierarchy` contains all exposure event variables to match to your device-event data. As such, the values within these variables must match exactly to the values within each respective variable in the device-event data `event_hierarchy` parameter. Exposures at an event level is not common.

#### Optional Arguments

```{r}
# Advanced usage
ex <- exposure(
  sales,
  time="sales_month",
  device_hierarchy="device_name",
  match_levels="region",
  count="sales_volume")
```

Optional arguments provide additional flexibility according to your data analysis needs.

- `count` is the most commonly specified optional parameter. It contains the number of exposures. If not specified, the number of rows will be used as a proxy for count.
- `key` is a unique identifier for each unique exposure in `data_frame`. If your data pipeline carries over a key variable, it is recommended to specify it here. The `key` allows downstream aggregated analysis to be able to "look up" individual constituent exposure records.
- `match_levels` are variables aside from time, device, and event that specify an exposure. A common "match level" is country, if your exposure data is specific by country.



********I AM HERE!!!!!!!!!***********

## `define_analyses()` to enumerate analyses combinations

### A summary view of all analyses

### A data frame view of all analyses

### Pick and choose the analyses you want

### Saving analyses for reproducibility

## `time_series()` to generate counts and/or rates

### Modify counts, exposures, and rates to suit your needs

## `plot()`ing a time series


The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
